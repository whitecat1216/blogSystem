<div class="dynamic-screen">
    
    <!-- タイトル -->
    <h2>{{ definition.title }}</h2>
    
    <!-- 検索フォーム -->
    <div class="search-form" ng-if="!editMode">
        <h4>検索条件</h4>
        <form class="form-inline" ng-submit="searchData()">
            <div class="form-group" ng-repeat="field in definition.searchFields" style="margin-right: 10px;">
                <label>{{ field.label }}:</label>
                
                <!-- テキスト入力 -->
                <input type="text" 
                       ng-if="field.type === 'text'" 
                       class="form-control" 
                       ng-model="searchParams[field.key]"
                       placeholder="{{ field.placeholder }}">
                
                <!-- 数値入力 -->
                <input type="number" 
                       ng-if="field.type === 'number'" 
                       class="form-control" 
                       ng-model="searchParams[field.key]">
                
                <!-- セレクトボックス -->
                <select ng-if="field.type === 'select'" 
                        class="form-control" 
                        ng-model="searchParams[field.key]">
                    <option value="">全て</option>
                    <option ng-repeat="option in field.options" value="{{ option }}">{{ option }}</option>
                </select>
            </div>
            
            <button type="submit" class="btn btn-primary">検索</button>
            <button type="button" class="btn btn-default" ng-click="resetSearch()">リセット</button>
        </form>
    </div>
    
    <!-- アクションボタン -->
    <div class="action-buttons" ng-if="!editMode">
        <button class="btn btn-success" ng-if="isAdmin" ng-click="createNew()">
            <span class="glyphicon glyphicon-plus"></span> 新規作成
        </button>
    </div>
    
    <!-- データ一覧（カードレイアウト優先） -->
    <div class="list-container" ng-if="!editMode">
        <div ng-if="definition.listLayout && definition.listLayout.type === 'card'">
            <div class="card-list">
                <div class="card-item" ng-repeat="record in records">
                    <div class="card-thumb" ng-if="definition.listLayout.imageField && record[definition.listLayout.imageField]">
                        <img ng-src="{{ record[definition.listLayout.imageField] }}" alt="thumbnail" />
                    </div>
                    <div class="card-content">
                                                <h3 class="card-title">
                                                    <a href="#!/post/{{record.id}}">{{ record[definition.listLayout.titleField] }}</a>
                                                </h3>
                        <div class="card-date" ng-if="definition.listLayout.dateField">{{ record[definition.listLayout.dateField] | date:'yyyy/MM/dd' }}</div>
                        <p class="card-excerpt" ng-if="definition.listLayout.excerptField">{{ record[definition.listLayout.excerptField] }}</p>
                        <div class="card-tags" ng-if="definition.listLayout.tagsField && record[definition.listLayout.tagsField]">{{ record[definition.listLayout.tagsField] }}</div>
                        <div class="card-actions">
                            <button class="btn btn-sm btn-info" ng-if="isAdmin" ng-click="editRecord(record)">
                                <span class="glyphicon glyphicon-edit"></span> 編集
                            </button>
                            <button class="btn btn-sm btn-danger" ng-if="isAdmin" ng-click="deleteRecord(record)">
                                <span class="glyphicon glyphicon-trash"></span> 削除
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div ng-if="!definition.listLayout || definition.listLayout.type !== 'card'">
            <table class="table table-striped table-bordered">
                <thead>
                    <tr>
                        <th ng-repeat="column in definition.listColumns">{{ column.label }}</th>
                        <th>操作</th>
                    </tr>
                </thead>
                <tbody>
                    <tr ng-repeat="record in records">
                        <td ng-repeat="column in definition.listColumns">{{ record[column.key] }}</td>
                        <td>
                            <button class="btn btn-sm btn-info" ng-if="isAdmin" ng-click="editRecord(record)">
                                <span class="glyphicon glyphicon-edit"></span> 編集
                            </button>
                            <button class="btn btn-sm btn-danger" ng-if="isAdmin" ng-click="deleteRecord(record)">
                                <span class="glyphicon glyphicon-trash"></span> 削除
                            </button>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
        
        <!-- ページネーション -->
        <div class="pagination-container" ng-if="totalPages > 1">
            <ul class="pagination">
                <li ng-class="{disabled: currentPage === 0}">
                    <a href="" ng-click="goToPage(currentPage - 1)">&laquo;</a>
                </li>
                <li ng-repeat="page in [] | range:totalPages" 
                    ng-class="{active: page === currentPage}">
                    <a href="" ng-click="goToPage(page)">{{ page + 1 }}</a>
                </li>
                <li ng-class="{disabled: currentPage === totalPages - 1}">
                    <a href="" ng-click="goToPage(currentPage + 1)">&raquo;</a>
                </li>
            </ul>
            <p class="text-center">
                全 {{ totalRecords }} 件中 {{ currentPage * pageSize + 1 }} - 
                {{ Math.min((currentPage + 1) * pageSize, totalRecords) }} 件を表示
            </p>
        </div>
    </div>
    
    <!-- 編集フォーム -->
    <div class="edit-form" ng-if="editMode">
        <h4>{{ isNewRecord ? '新規作成' : '編集' }}</h4>
        <form ng-submit="save()">
            <div class="form-group" ng-repeat="field in definition.formFields">
                <label>{{ field.label }} <span ng-if="field.required" class="text-danger">*</span></label>
                
                <!-- テキスト入力 -->
                <input type="text" 
                       ng-if="field.type === 'text'" 
                       class="form-control" 
                       ng-model="currentRecord[field.key]"
                       ng-required="field.required">
                
                <!-- 数値入力 -->
                <input type="number" 
                       ng-if="field.type === 'number'" 
                       class="form-control" 
                       ng-model="currentRecord[field.key]"
                       ng-required="field.required">
                
                <!-- テキストエリア -->
                <textarea ng-if="field.type === 'textarea'" 
                          class="form-control" 
                          rows="5"
                          ng-model="currentRecord[field.key]"
                          ng-required="field.required"></textarea>
                
                <!-- セレクトボックス -->
                <select ng-if="field.type === 'select'" 
                        class="form-control" 
                        ng-model="currentRecord[field.key]"
                        ng-required="field.required">
                    <option value="">選択してください</option>
                    <option ng-repeat="option in field.options" value="{{ option }}">{{ option }}</option>
                </select>
                <!-- マルチセレクト -->
                <div ng-if="field.type === 'multiselect'">
                    <select multiple class="form-control" ng-model="currentRecord[field.key]"
                            ng-options="opt.id as opt.name for opt in field._options"></select>
                    <div class="add-option" ng-if="field.allowCreate" style="margin-top:6px;">
                        <div class="input-group">
                            <input type="text" class="form-control" placeholder="新規タグ" ng-model="field._newName">
                            <span class="input-group-btn">
                                <button type="button" class="btn btn-default" ng-click="addNewOption(field, field._newName)">追加</button>
                            </span>
                        </div>
                    </div>
                </div>
                <!-- リッチテキスト（Quill） -->
                <div ng-if="field.type === 'richtext'">
                    <div class="quill-editor" id="quill_{{field.key}}" style="height:300px;"></div>
                </div>
                <div ng-if="field.type === 'file'">
                    <input type="file" accept="{{ field.accept || '*/*' }}"
                           onchange="angular.element(this).scope().onFileSelected(field, this.files)">
                    <div class="preview" ng-if="currentRecord[field.key]" style="margin-top:8px;">
                        <img ng-if="field.accept && field.accept.indexOf('image') !== -1" ng-src="{{ currentRecord[field.key] }}" style="max-width:200px;" />
                        <a ng-if="!field.accept || field.accept.indexOf('image') === -1" ng-href="{{ currentRecord[field.key] }}" target="_blank">アップロード済みファイル</a>
                    </div>
                </div>
            </div>
            
            <div class="form-group">
                <button type="submit" class="btn btn-primary" ng-if="isAdmin">
                    <span class="glyphicon glyphicon-save"></span> 保存
                </button>
                <button type="button" class="btn btn-default" ng-click="cancel()">
                    <span class="glyphicon glyphicon-remove"></span> キャンセル
                </button>
            </div>
        </form>
    </div>
    
</div>
