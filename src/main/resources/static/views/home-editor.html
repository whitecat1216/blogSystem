<div class="home-editor-page" ng-controller="HomeEditorController">
    <div class="page-header">
        <h1>
            <span class="glyphicon glyphicon-home"></span> ホーム画面編集
        </h1>
        <p class="text-muted">ホーム画面のレイアウトとコンテンツを編集します</p>
    </div>
    
    <div ng-if="loading" class="text-center" style="padding: 50px 0;">
        <span class="glyphicon glyphicon-refresh spinning"></span> 読み込み中...
    </div>
    
    <div ng-if="!loading">
        <!-- アラート -->
        <div ng-if="error" class="alert alert-danger alert-dismissible">
            <button type="button" class="close" ng-click="error = null">&times;</button>
            <span class="glyphicon glyphicon-exclamation-sign"></span> {{ error }}
        </div>
        
        <div ng-if="success" class="alert alert-success alert-dismissible">
            <button type="button" class="close" ng-click="success = null">&times;</button>
            <span class="glyphicon glyphicon-ok-circle"></span> {{ success }}
        </div>
        
        <!-- ツールバー -->
        <div class="btn-toolbar" style="margin-bottom: 20px;">
            <div class="btn-group">
                <button class="btn" ng-class="editMode === 'visual' ? 'btn-primary' : 'btn-default'" 
                        ng-click="editMode = 'visual'">
                    <span class="glyphicon glyphicon-eye-open"></span> ビジュアル
                </button>
                <button class="btn" ng-class="editMode === 'json' ? 'btn-primary' : 'btn-default'" 
                        ng-click="editMode = 'json'">
                    <span class="glyphicon glyphicon-list-alt"></span> JSON
                </button>
            </div>
            
            <div class="btn-group">
                <button class="btn btn-success" ng-click="save()" ng-disabled="saving">
                    <span class="glyphicon glyphicon-floppy-disk"></span> 
                    {{ saving ? '保存中...' : '保存' }}
                </button>
                <button class="btn btn-info" ng-click="preview()">
                    <span class="glyphicon glyphicon-eye-open"></span> プレビュー
                </button>
                <button class="btn btn-default" ng-click="loadHistory()">
                    <span class="glyphicon glyphicon-time"></span> 履歴
                </button>
            </div>
        </div>
        
        <!-- ビジュアルエディタ -->
        <div ng-if="editMode === 'visual'">
            <div class="panel panel-default">
                <div class="panel-heading">
                    <h3 class="panel-title">
                        セクション
                        <span class="badge">{{ sections.length }}</span>
                    </h3>
                </div>
                <div class="panel-body">
                    <!-- セクション追加ボタン -->
                    <div class="btn-group" style="margin-bottom: 20px;">
                        <button class="btn btn-sm btn-primary dropdown-toggle" data-toggle="dropdown">
                            <span class="glyphicon glyphicon-plus"></span> セクションを追加 <span class="caret"></span>
                        </button>
                        <ul class="dropdown-menu">
                            <li><a href="javascript:void(0)" ng-click="addSection('hero')">ヒーロー/スライドショー</a></li>
                            <li><a href="javascript:void(0)" ng-click="addSection('text-block')">テキストブロック</a></li>
                            <li><a href="javascript:void(0)" ng-click="addSection('stats')">統計情報</a></li>
                            <li><a href="javascript:void(0)" ng-click="addSection('recent-posts')">最新記事</a></li>
                            <li><a href="javascript:void(0)" ng-click="addSection('category-grid')">カテゴリグリッド</a></li>
                            <li><a href="javascript:void(0)" ng-click="addSection('custom-html')">カスタムHTML</a></li>
                        </ul>
                    </div>
                    
                    <!-- セクション一覧 -->
                    <div ng-if="sections.length === 0" class="alert alert-info">
                        セクションがありません。「セクションを追加」ボタンから追加してください。
                    </div>
                    
                    <div ng-repeat="section in sections" class="section-item panel panel-default" style="margin-bottom: 15px;">
                        <div class="panel-heading">
                            <div class="pull-right">
                                <button class="btn btn-xs btn-default" ng-click="moveSectionUp($index)" ng-disabled="$index === 0">
                                    <span class="glyphicon glyphicon-arrow-up"></span>
                                </button>
                                <button class="btn btn-xs btn-default" ng-click="moveSectionDown($index)" ng-disabled="$index === sections.length - 1">
                                    <span class="glyphicon glyphicon-arrow-down"></span>
                                </button>
                                <button class="btn btn-xs btn-danger" ng-click="removeSection($index)">
                                    <span class="glyphicon glyphicon-trash"></span>
                                </button>
                            </div>
                            <h4 class="panel-title">
                                <span class="badge">{{ $index + 1 }}</span>
                                {{ section.type }} 
                                <small ng-if="section.heading">- {{ section.heading }}</small>
                            </h4>
                        </div>
                        <div class="panel-body">
                            <pre style="max-height: 200px; overflow: auto;">{{ section | json }}</pre>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- JSONエディタ -->
        <div ng-if="editMode === 'json'">
            <div class="panel panel-default">
                <div class="panel-heading">
                    <h3 class="panel-title">JSON編集</h3>
                </div>
                <div class="panel-body">
                    <textarea class="form-control" rows="30" ng-model="jsonText" 
                              style="font-family: monospace; font-size: 12px;"
                              ng-change="syncFromJson()"></textarea>
                </div>
            </div>
        </div>
        
        <!-- 履歴モーダル -->
        <div ng-if="showHistory" class="modal" style="display: block; background: rgba(0,0,0,0.5);">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <button type="button" class="close" ng-click="showHistory = false">&times;</button>
                        <h4 class="modal-title">設定変更履歴</h4>
                    </div>
                    <div class="modal-body">
                        <table class="table table-bordered">
                            <thead>
                                <tr>
                                    <th>バージョン</th>
                                    <th>更新日時</th>
                                    <th>更新者</th>
                                    <th>操作</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr ng-repeat="item in history">
                                    <td>{{ item.version }}</td>
                                    <td>{{ item.updated_at | date:'yyyy/MM/dd HH:mm:ss' }}</td>
                                    <td>{{ item.updated_by }}</td>
                                    <td>
                                        <button class="btn btn-xs btn-primary" ng-click="restoreVersion(item.version)">
                                            <span class="glyphicon glyphicon-refresh"></span> 復元
                                        </button>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <div class="modal-footer">
                        <button class="btn btn-default" ng-click="showHistory = false">閉じる</button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- プレビューモーダル -->
        <div ng-if="showPreview" class="modal" style="display: block; background: rgba(0,0,0,0.5);">
            <div class="modal-dialog" style="width: 90%; max-width: 1200px;">
                <div class="modal-content">
                    <div class="modal-header">
                        <button type="button" class="close" ng-click="showPreview = false">&times;</button>
                        <h4 class="modal-title">プレビュー</h4>
                    </div>
                    <div class="modal-body" style="max-height: 80vh; overflow: auto;">
                        <iframe src="#!/" style="width: 100%; height: 600px; border: 1px solid #ddd;"></iframe>
                    </div>
                    <div class="modal-footer">
                        <button class="btn btn-default" ng-click="showPreview = false">閉じる</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
